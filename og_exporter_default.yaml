pg_bgwriter:
  name: pg_bgwriter
  query:
  - name: pg_bgwriter
    sql: |-
      SELECT checkpoints_timed,
          checkpoints_req,
          checkpoint_write_time,
          checkpoint_sync_time,
          buffers_checkpoint,
          buffers_clean,
          buffers_backend,
          maxwritten_clean,
          buffers_backend_fsync,
          buffers_alloc,
          stats_reset
      FROM pg_stat_bgwriter;;
    version: '>=0.0.0'
    timeout: 0.1
    status: enable
  metrics:
  - name: checkpoints_timed
    description: scheduled checkpoints that have been performed
    usage: COUNTER
  - name: checkpoints_req
    description: requested checkpoints that have been performed
    usage: COUNTER
  - name: checkpoint_write_time
    description: time spending on writing files to disk, in µs
    usage: COUNTER
  - name: checkpoint_sync_time
    description: time spending on syncing files to disk, in µs
    usage: COUNTER
  - name: buffers_checkpoint
    description: buffers written during checkpoints
    usage: COUNTER
  - name: buffers_clean
    description: buffers written by the background writer
    usage: COUNTER
  - name: buffers_backend
    description: buffers written directly by a backend
    usage: COUNTER
  - name: maxwritten_clean
    description: times that bgwriter stopped a cleaning scan
    usage: COUNTER
  - name: buffers_backend_fsync
    description: times a backend had to execute its own fsync
    usage: COUNTER
  - name: buffers_alloc
    description: buffers allocated
    usage: COUNTER
  - name: stats_reset
    description: time when statistics were last reset
    usage: COUNTER
  status: enable
  ttl: 60
  timeout: 0.1
pg_database:
  name: pg_database
  query:
  - name: pg_database
    sql: SELECT pg_database.datname, pg_database_size(pg_database.datname) as size_bytes FROM pg_database
    version: '>=0.0.0'
    timeout: 0.1
    status: enable
  metrics:
  - name: datname
    description: Name of this database
    usage: LABEL
  - name: size_bytes
    description: Disk space used by the database
    usage: GAUGE
  status: enable
  ttl: 60
  timeout: 0.1
pg_lock:
  name: pg_lock
  desc: OpenGauss lock distribution by mode
  query:
  - name: pg_lock
    sql: |-
      SELECT
        pg_database.datname,
        tmp.mode,
        COALESCE(count,0) as count
      FROM
          (
            VALUES ('accesssharelock'),
                   ('rowsharelock'),
                   ('rowexclusivelock'),
                   ('shareupdateexclusivelock'),
                   ('sharelock'),
                   ('sharerowexclusivelock'),
                   ('exclusivelock'),
                   ('accessexclusivelock')
          ) AS tmp(mode) CROSS JOIN pg_database
      LEFT JOIN
        (SELECT database, lower(mode) AS mode,count(*) AS count
        FROM pg_locks WHERE database IS NOT NULL
        GROUP BY database, lower(mode)
      ) AS tmp2
      ON tmp.mode=tmp2.mode and pg_database.oid = tmp2.database ORDER BY 1
    version: '>=0.0.0'
    timeout: 0.1
    status: enable
  metrics:
  - name: datname
    description: Name of this database
    usage: LABEL
  - name: mode
    description: Type of Lock
    usage: LABEL
  - name: count
    description: Number of locks
    usage: GAUGE
  status: enable
  ttl: 60
  timeout: 0.1
pg_stat_activity:
  name: pg_stat_activity
  query:
  - name: pg_stat_activity
    sql: |-
      SELECT
        pg_database.datname,
        tmp.state,
        COALESCE(count,0) as count,
        COALESCE(max_tx_duration,0) as max_tx_duration
      FROM
        (
          VALUES ('active'),
               ('idle'),
               ('idle in transaction'),
               ('idle in transaction (aborted)'),
               ('fastpath function call'),
               ('disabled')
        ) AS tmp(state) CROSS JOIN pg_database
      LEFT JOIN
      (
        SELECT
          datname,
          state,
          count(*) AS count,
          MAX(EXTRACT(EPOCH FROM now() - xact_start))::float AS max_tx_duration
        FROM pg_stat_activity GROUP BY datname,state) AS tmp2
        ON tmp.state = tmp2.state AND pg_database.datname = tmp2.datname
    version: '>=1.0.0'
    timeout: 0.1
    status: enable
  metrics:
  - name: datname
    description: Name of this database
    usage: LABEL
  - name: state
    description: connection state
    usage: LABEL
  - name: count
    description: number of connections in this state
    usage: GAUGE
  - name: max_tx_duration
    description: max duration in seconds any active transaction has been running
    usage: GAUGE
  status: enable
  ttl: 60
  timeout: 0.1
pg_stat_replication:
  name: pg_stat_replication
  query:
  - name: pg_stat_replication
    sql: |-
      SELECT *,
        (case pg_is_in_recovery() when 't' then null else pg_current_xlog_location() end) AS pg_current_xlog_location,
        (case pg_is_in_recovery() when 't' then null else pg_xlog_location_diff(pg_current_xlog_location(), receiver_replay_location)::float end) AS pg_xlog_location_diff
      FROM pg_stat_replication
    version: '>=1.0.0'
    timeout: 0.1
    status: enable
  metrics:
  - name: pid
    description: Process ID of a WAL sender process
    usage: DISCARD
  - name: usesysid
    description: OID of the user logged into this WAL sender process
    usage: DISCARD
  - name: usename
    description: Name of the user logged into this WAL sender process
    usage: DISCARD
  - name: application_name
    description: Name of the application that is connected to this WAL sender
    usage: LABEL
  - name: client_addr
    description: IP address of the client connected to this WAL sender. If this field is null, it indicates that the client is connected via a Unix socket on the server machine.
    usage: LABEL
  - name: client_hostname
    description: Host name of the connected client, as reported by a reverse DNS lookup of client_addr. This field will only be non-null for IP connections, and only when log_hostname is enabled.
    usage: DISCARD
  - name: client_port
    description: TCP port number that the client is using for communication with this WAL sender, or -1 if a Unix socket is used
    usage: DISCARD
  - name: backend_start
    description: with time zone      Time when this process was started, i.e., when the client connected to this WAL sender
    usage: DISCARD
  - name: state
    description: Current WAL sender state
    usage: LABEL
  - name: sender_sent_location
    description: Last transaction log position sent on this connection
    usage: GAUGE
  - name: receiver_write_location
    description: Last transaction log position written to disk by this standby server
    usage: GAUGE
  - name: receiver_flush_location
    description: Last transaction log position flushed to disk by this standby server
    usage: GAUGE
  - name: receiver_replay_location
    description: Last transaction log position replayed into the database on this standby server
    usage: GAUGE
  - name: sync_priority
    description: Priority of this standby server for being chosen as the synchronous standby
    usage: DISCARD
  - name: sync_state
    description: Synchronous state of this standby server
    usage: GAUGE
  - name: pg_current_xlog_location
    description: pg_current_xlog_location
    usage: DISCARD
  - name: pg_xlog_location_diff
    description: Lag in bytes between master and slave
    usage: GAUGE
  status: enable
  ttl: 60
  timeout: 0.1

